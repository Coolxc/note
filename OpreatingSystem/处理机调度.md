调度要解决的问题：当有一堆任务要处理时，由于资源有限。需要用某种规则来决定这些任务的处理顺序以达到最高的效率。

在多道程序系统中，进程的数量往往是多于处理机的个数的，这样并不可能同时并行的处理各个进程。处理机调度就是从就绪队列中按照一定的算法选择一个进程并将处理机分配给他运行，以实现进程的并发执行

#### 调度的三个层次

##### 高级调度（作业调度）

**高级调度：**按照一定的原则从外存上处于后备队列的作业中挑选一个（或多个）作业，给他们分配内存等必要资源，并建立相应的进程（建立PCB），以使他们获得竞争处理机的权利。

高级调度是外存与内存之间的调度。每个作业只调入一次，调出一次。作业调入时会建立相应的PCB，作业调出时才撤销PCB。高级调度主要是指调入的问题，因为只有调入的时机需要操作系统来确定，但调出的时机必然是作业运行结束才调出。

##### 中级调度

引入了虚拟存储技术后，可以将暂不能运行的进程调至外存等待。等他重新具备了运行条件且内存又稍有空闲时再重新调入内存。

这么做的目的是为了提高内存利用率和系统吞吐量

暂时调到外存等待的进程状态为挂起状态。值得注意的是PCB并不会一起调到外存，而是会常驻内存。PCB中会记录进程数据在外存中的位置、进程状态等信息。操作系统通过内存中的PCB来保持对各个进程的监控、管理。被挂起的进程PCB会被放到挂起队列中。

**中级调度：**就是要决定哪个处于挂起状态的进程重新调入内存。相对于高级调度只可能调入一次，中极调度同一个进程可能会被多次调度、调入内存，因此中级调度发生的频率要比高级调度更高。

##### 低级调度

**低级调度（进程调度）：**主要任务就是按照某种方法和策略从就绪队列中选取一个进程，将处理机分配给他

进程调度是操作系统中最基本的一种调度，在一般的操作系统中都必须配置进程调度

进程调度的频率很高，一般几十毫秒一次

<img src=".\图片\image-20200412162606798.png" alt="image-20200412162606798" style="zoom: 80%;" />

#### 进程调度的时机

进程调度，也就是低级调度：按照某种算法从就绪队列中选择一个进程为其分配处理机

**当前运行的进程主动放弃处理机**

> 进程正常终止
>
> 运行过程中发生异常而终止
>
> 进程主动请求阻塞（如等待IO）

**当前运行的进程被动放弃处理机**

> 分给进程的时间片用完
>
> 有更紧急的事需要处理
>
> 有更高优先级的进程进入就绪队列

**有些情况是不能进行进程调度和切换的**

> 1. 在处理中断的过程中。中断处理过程复杂，与硬件密切相关，很难做到在中断处理过程中进行进程切换
> 2. 进程在操作系统内核程序临界区中
>
> > 内核临界区不同于临界区，临界区指的是那些临界资源。内核临界区一般是用来访问某种内核数据结构的，比如进程的就绪队列（由各就绪进程的PCB组成）
>
> 3. 在原子操作过程中（原语）。原子操作是不可阻断的，必须一气呵成（如修改PCB状态标志并将PCB放入到相应队列，这两个操作不可被其他任何中断分割）

#### 调度算法

##### 先来先服务（FCFS，First Come First Serve）

按照到达的先后顺序运行

> 优点：公平
>
> 缺点：排在长作业（进程）后面的短作业等待的时间特别长，对于短作业不友好
>
> 不会导致饥饿

##### 短作业优先（SJF，Shortest Job First）

最短的作业（进程）优先服务

> 每当有进程加入，就绪队列改变时就需要进行调度，如果新到达的进程剩余时间比当前运行的进程剩余时间更短，那么新进程就会抢占处理机，当前运行的进程重新回到就绪队列。另外，当一个进程完成时也就是主动释放处理机时也需要进行调度
>
> 优点：短作业友好
>
> 缺点：长作业不利，会导致长作业饥饿
>
> 会导致饥饿：如果队列中有源源不断的短作业到达那么长作业就会一直等待

##### 高相应比优先（HRRN，Highest Response Ratio Next）

综合考虑作业/进程的等待时间和要求服务的时间

> 在每次调度时先计算各个作业/进程的响应比，选择响应比最高的作业/进程为其服务。响应比=等待时间+要求服务时间 / 要求服务时间
>
> 非抢占式算法，只有当前运行的进程主动放弃CPU时才需要进行调度
>
> <img src=".\图片\image-20200412204824571.png" alt="image-20200412204824571" style="zoom:80%;" />
>
> 优缺点：综合考虑了等待时间和运行时间（要求服务时间）。
>
> > 等待时间相同时，要求服务时间短的优先（SJF的优点）
> >
> > 要求服务时间相同时，等待时间长的优先（FCFS的优点）
> >
> > 对于长作业来说，随着等待时间越来越久，其相应比也会越来越大，从而避免了长作业饥饿的问题
>
> 不会导致饥饿

**这三种算法只用在以前的批处理系统，现在已经过时了**

##### 时间片轮转（RR，Round-Robin）

公平、轮流的为各个进程服务

> 按照各进程到达就绪队列的顺序，轮流让各个进程执行一个时间片。若进程未在一个时间片执行完则被剥夺处理机，该进程重新回到就绪队列尾部重新排队
>
> 由时钟装置发出时钟中断来通知CPU时间片已到，那么CPU上运行的进程将被强行剥夺处理机使用权，所以是抢占式的算法
>
> 如果设置的时间片太大，使得每个进程都可以在一个时间片内完成。那么就退化成了先来先服务的调度算法。因此时间片不能太大。
>
> 如果时间片太小就会面临过于频繁的进程切换问题，导致系统开销过大
>
> 优点：公平、响应快，适用于分时操作系统
>
> 缺点：由于高频率的进程切换，因此会有一定的系统开销。并且不会区分任务的紧急程度
>
> 不会导致饥饿，每个任务都会获得处理机

##### 优先级调度算法

根据任务的紧急程度来决定处理顺序

> 每个作业/进程都有各自的优先级，调度时选择优先级最高的作业/进程
>
> 抢占式和非抢占式这两种方式都有。抢占式的只有等待进程主动放弃处理机
>
> 优先级一样时先来先服务
>
> 抢占式的方式时：当队列中有新的进程到达并且比运行中的进程优先级更高时那么就会抢占处理机让更高优先级的进程运行。被抢的进程又回到就绪队列。
>
> **优先级设置规则**
>
> > 系统进程的优先级高于用户进程
> >
> > 前台进程的优先级高于后台进程
> >
> > 操作系统更偏好IO密集型进程，与之对应的是CPU计算繁忙型进程
> >
> > > IO设备和CPU可以并行的工作。如果先让IO繁忙型进程优先运行的话，则越有可能使IO设备尽早的投入工作，那么资源的利用率、系统吞吐量都会得到提升
> >
> > 如果某进程在就绪队列中等待了很长时间那么可以适当的提升一下他的优先级。如果某进程占用处理机运行了很长时间，则可以适当降低其优先级
>
> 优点：可以灵活的调整各种作业/进程的重要/紧急程度
>
> 缺点：若源源不断的有高优先级进程到来，则可能导致饥饿

##### 多级反馈队列调度算法

对所有调度算法的折中权衡

> 设置多级的就绪队列，各级队列优先级从高到低，时间片从小到大
>
> 新进程到达时先进入1级队列，按照FCFS原则排队等待被分配时间片，若用完时间片进程还未结束，则进程进入下一级队列对尾。若此时已经是在最下级的队列，则重新放回该队列对尾
>
> 只有第K级队列为空时，才会为他的下一级K+1级队列分配时间片
>
> 该算法有抢占式和非抢占式。抢占式：在K级队列的进程运行过程中，若更上级的队列中进入了一个新进程，则由于新进程处于优先级更高的队列中，因此新进程会抢占处理机，原来运行的进程放回K级队列队尾
>
> ![image-20200412214043105](.\图片\image-20200412214043105.png)
>
> 刚开始p1进第一级队列，此时时间片大小为1，时间片到了那么p1被放入了下面的第二级队列。正好p2到达，此时p2运行。然后p2运行结束也被放到第二级队列
>
> 此时第一级队列是空的，所以根据上面的原则可以为第二级队列分配时间片了，此时该p1运行了，运行了2个单位的时间片后被放到下一级第三级队列。此时该p2上处理机了
>
> p2运行到1个单位的时间片时p3进入了，根据规则新进入的进程应该被放到第一级队列中，所以p3会抢占处理机，此时p2回到它原来的第二级队列的队尾。
>
> p3执行完毕，然后p2上处理机
>
> .........................
>
> 可以看到p2虽然被抢占了，但是它在第二级队列中算是运行了3个时间片。血赚
>
> **优缺点：**对各类型进程相对公平（FCFS的优点）；每个新到达的进程都可以很快就得到响应（RR的优点）；短进程只用比较少的时间就可以完成（SRF的优点）；不必实现估计进程的运行时间（避免用户作假）；可以灵活的调整对各类进程的偏好程度，比如CPU密集型进程、IO密集型进程（可以将因IO而阻塞的进程重新放回原队列而不是放到下一级，这样IO型进程就可以保持较高的优先级）
>
> 如果有源源不断的短进程到达那么都会在前几级队列那么可能会导致饥饿

## 应用案例

### 应用1-男主人处理妻子和母亲的要求

案例：中国男人在婆媳关系的融洽中起着非常重要的作用。现有一例子，母亲有一件事情A要男人帮忙，1小时后妻子也有一件事情B要男人帮忙，两件事情各自需要的时间为2小时和1小时。假设事情在家里就可以完成，男人在家，母亲叫儿子帮忙后，男人开始做的时间为下午3:00。 男人该怎么样分配做事情的顺序？

解决步骤：

1. 根据题目，设定男人连续做事时长分别为半小时和1小时
2. 下午3:00，按照先来先服务原则，母亲先叫儿子办事情，所以男人先帮母亲做事情A，此时事情A等级为1；
3. 下午4:00，妻子叫男人帮忙，于是男人暂停事情A（事情A还剩下1个小时的执行过程），开始做事情B，事情B等级为1，此时事情A等级降为2，
4. 下午4:30，男人暂停事情B，此时事情B等级降为2（事情B还剩下半个小时的执行过程），帮母亲干事情A
5. 下午5:30，男人完成事情A，帮妻子干事情B
6. 下午6:00，男人完成事情B

这个过程中，男人既完了了母亲的任务，也完成了妻子的任务，两件事情交叉处理，没有出现母亲一直等，或是妻子一直等的情况。这就是多任务的一种调度方式。

## 可以体现的计算思维

多级反馈队列调度算法体现了计算思维的调度特点，应用了先来先服务原则、应用时间片等做法使得每个申请者都能及时使用资源，是一种很好的协调整体的解决方案。